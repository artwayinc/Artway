/**
 * Migrate data from data/*.json to D1.
 * Reads data/schedule.json, data/messages.json, data/reviews.json
 * and writes scripts/d1-migrate-data.sql. Then run:
 *   npx wrangler d1 execute artway-db --remote --file=./scripts/d1-migrate-data.sql
 */
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.join(__dirname, "..");
const dataDir = path.join(repoRoot, "data");
const outFile = path.join(__dirname, "d1-migrate-data.sql");

function esc(s) {
  if (s == null) return "NULL";
  return "'" + String(s).replace(/'/g, "''") + "'";
}

function readJson(name) {
  const p = path.join(dataDir, name);
  if (!fs.existsSync(p)) return [];
  const raw = fs.readFileSync(p, "utf-8");
  const data = JSON.parse(raw);
  return Array.isArray(data) ? data : [];
}

const schedule = readJson("schedule.json");
const messages = readJson("messages.json");
const reviews = readJson("reviews.json");

const lines = [
  "-- Generated by scripts/migrate-json-to-d1.mjs â€” migrate JSON data into D1",
  "-- Run: npx wrangler d1 execute artway-db --remote --file=./scripts/d1-migrate-data.sql",
  "",
];

// Schedule: id, date, name, location, url, sort_order
lines.push("-- Schedule");
for (let i = 0; i < schedule.length; i++) {
  const e = schedule[i];
  const id = e.id ?? "";
  const date = e.date ?? "";
  const name = e.name ?? "";
  const location = e.location ?? "";
  const url = e.url != null && e.url !== "" ? esc(e.url) : "NULL";
  lines.push(
    `INSERT OR REPLACE INTO schedule (id, date, name, location, url, sort_order) VALUES (${esc(id)}, ${esc(date)}, ${esc(name)}, ${esc(location)}, ${url}, ${i});`
  );
}
lines.push("");

// Messages: id, name, email, phone, phone_country, subject, message, created_at, read
lines.push("-- Messages");
for (const m of messages) {
  const read = m.read === true || m.read === 1 ? 1 : 0;
  const phoneCountry = m.phoneCountry ?? m.phone_country ?? "";
  lines.push(
    `INSERT OR REPLACE INTO messages (id, name, email, phone, phone_country, subject, message, created_at, read) VALUES (${esc(m.id)}, ${esc(m.name)}, ${esc(m.email)}, ${esc(m.phone)}, ${esc(phoneCountry)}, ${esc(m.subject)}, ${esc(m.message)}, ${esc(m.createdAt)}, ${read});`
  );
}
lines.push("");

// Reviews: id, rating, title, text, author, role, location, image, sort_order
lines.push("-- Reviews");
for (let i = 0; i < reviews.length; i++) {
  const r = reviews[i];
  const image = r.image != null && r.image !== "" ? esc(r.image) : "NULL";
  lines.push(
    `INSERT OR REPLACE INTO reviews (id, rating, title, text, author, role, location, image, sort_order) VALUES (${esc(r.id)}, ${r.rating}, ${esc(r.title)}, ${esc(r.text)}, ${esc(r.author)}, ${esc(r.role)}, ${esc(r.location)}, ${image}, ${i});`
  );
}

fs.writeFileSync(outFile, lines.join("\n"), "utf-8");
console.log(`Wrote ${outFile}: ${schedule.length} schedule, ${messages.length} messages, ${reviews.length} reviews.`);
console.log("Run: npx wrangler d1 execute artway-db --remote --file=./scripts/d1-migrate-data.sql");
